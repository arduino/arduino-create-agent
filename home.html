<!DOCTYPE html>
<html lang="en">

<head>
    <title>Arduino Create Agent Debug Console</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,600,700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript">
        $(function () {
            var socket;
            var input = $('#input');
            var log = document.getElementById('log');
            var logList = document.getElementById('log-list');

            var autoscroll = document.getElementById('autoscroll');
            var messages = [];
            const MESSAGES_MAX_COUNT = 2000;

            // Check if the list visibility setting is saved in the localStorage.
            const LOCAL_STORAGE_KEY = "ArduinoAgentListVisibility";
            let savedSetting = localStorage.getItem(LOCAL_STORAGE_KEY);
            let listCommand = savedSetting != null ? parseInt(savedSetting) : 1; // Default: Show list commands inline.
            document.getElementById('listShow').value = listCommand;
            updateLogVisibility();

            function appendLog(msg) {
                let jsonMsg = {};
                let portsListing = false;
                try {
                    // Try to parse the received message as JSON, and then check if it contains a "Ports" property.
                    jsonMsg = JSON.parse(msg);
                    portsListing = jsonMsg.Ports !== undefined;
                } catch {
                    // no valid json
                }

                // This is a "list" message if it starts with "list" or if it's valid JSON and has a "Ports" property.
                let isListMessage = portsListing || msg.indexOf('list') == 0;

                // If this is a "LIST" command and we want to hide them. Skip.
                if (isListMessage && listCommand == 0) return;


                let printMsg = msg;
                if (jsonMsg.Ports) {
                    const validKeys = ['Name', 'SerialNumber', 'IsOpen', 'VendorID', 'ProductID'];
                    printMsg = "Serial Ports:\n" + JSON.stringify(jsonMsg.Ports, validKeys, 2);
                } else if (Object.keys(jsonMsg).length !== 0) {
                    printMsg = JSON.stringify(jsonMsg, undefined, 2);
                }

                // when parsing JSON we're escaping some html charaters like "&<>", we want to show their
                // original value in the log
                function decode(str) {
                    let txt = new DOMParser().parseFromString(str, "text/html");
                    return txt.documentElement.textContent;
                }
                printMsg = decode(printMsg);


                // Check if this is a "LIST" message and needs to be shown in a separate log.
                if (isListMessage && listCommand == 2) {
                    // Show the "list" message in the specific log element. Replace any previous content.
                    logList.textContent = "list\n\n" + printMsg;

                } else {
                    // Show the message in the log element.
                    messages.push(printMsg);
                    if (messages.length > MESSAGES_MAX_COUNT) {
                        messages.shift();
                    }
                    log.textContent = messages.join('\n\n');
                    if (autoscroll.checked) {
                        log.scrollTop = log.scrollHeight - log.clientHeight;
                    }
                }
            }

            $('#form').submit(function (e) {
                e.preventDefault();
                if (!socket) {
                    return false;
                }
                if (!input.val()) {
                    return false;
                }
                socket.emit('command', input.val());
                input.val('');
            });

            $('#export').click(function () {
                var link = document.createElement('a');
                link.setAttribute('download', 'agent-log.txt');
                var text = log.textContent;
                link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                link.click();
            });

            $('#clear').click(function () {
                messages = [];
                log.innerHTML = '';
                logList.innerHTML = '';
            });

            $('#listShow').change(function () {
                listCommand = document.getElementById('listShow').value;
                localStorage.setItem(LOCAL_STORAGE_KEY, "" + listCommand);
                updateLogVisibility();
            });

            function updateLogVisibility() {
                if (listCommand == 2) {
                    logList.innerHTML = '';
                    $("#log-list").show();
                } else {
                    $("#log-list").hide();
                }
            }

            if (window['WebSocket']) {
                if (window.location.protocol === 'https:') {
                    socket = io('https://{{$}}')
                } else {
                    socket = io('http://{{$}}');
                }
                socket.on('disconnect', function (evt) {
                    appendLog('Connection closed.')
                });
                socket.on('message', function (evt) {
                    appendLog(evt);
                });
            } else {
                appendLog('Your browser does not support WebSockets.')
            }

            $("#input").focus();
        });
    </script>
    <style type="text/css">
        html,
        body {
            overflow: hidden;
            height: 100%;
        }

        body {
            margin: 0px;
            padding: 0px;
            background: #F8F9F9;
            font-size: 16px;
            font-family: "Open Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
        }

        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .logs {
            display: flex;
            gap: 10px;

            flex: 1;
            overflow-y: auto;
            margin: 15px 15px 10px;

            font-family: "Roboto Mono", "Courier", "Lucida Grande", Verdana, sans-serif;
        }

        .logs pre {
            background-color: #DAE3E3;
            padding: 8px 10px;
            margin: 0;
            overflow-y: auto;
        }

        #log {
            flex-basis: 65%;
            flex-grow: 1;
        }

        #log-list {
            flex-basis: 35%;
        }

        #footer {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            margin: 0px 15px 0px;
        }

        #form {
            display: flex;
            flex-grow: 1;
            margin-bottom: 15px;
        }

        #input {
            flex-grow: 1;
        }

        #secondary-controls div {
            display: inline-block;
            padding: 10px 15px;
        }

        #autoscroll,
        #list {
            vertical-align: middle;
            width: 20px;
            height: 20px;
        }


        #secondary-controls .button {
            margin-bottom: 15px;
            vertical-align: top;
            height: 36px;
        }

        .button {
            background-color: #b5c8c9;
            border: 1px solid #b5c8c9;
            border-radius: 2px 2px 0 0;
            box-shadow: 0 4px #95a5a6;
            margin-bottom: 4px;
            color: #000;
            cursor: pointer;
            font-size: 14px;
            letter-spacing: 1.28px;
            line-height: normal;
            outline: none;
            padding: 9px 18px;
            text-align: center;
            text-transform: uppercase;
            transition: box-shadow .1s ease-out, transform .1s ease-out;
        }

        .button:hover {
            box-shadow: 0 2px #95a5a6;
            outline: none;
            transform: translateY(2px);
        }

        .button:active {
            box-shadow: none;
            transform: translateY(4px);
        }

        .textfield {
            background-color: #dae3e3;
            width: auto;
            height: auto;
            padding: 10px 8px;
            margin-left: 8px;
            vertical-align: top;
            border: none;
            font-family: "Open Sans", "Lucida Grande", Lucida, Verdana, sans-serif;
            font-size: 1em;
            outline: none;
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="logs">
            <pre id="log"></pre>
            <pre id="log-list"></pre>
        </div>
        <div id="footer">
            <form id="form">
                <input type="submit" class="button" value="Send" />
                <input type="text" id="input" class="textfield" aria-label="send command" autocomplete="off" />
            </form>
            <div id="secondary-controls">
                <div>
                    <input name="pause" type="checkbox" checked id="autoscroll" />
                    <label for="autoscroll">Autoscroll</label>
                </div>
                <select name="listShow" id="listShow" class="button">
                    <option value="0">Hide 'list' commands</option>
                    <option value="1" selected>Show 'list' commands inline</option>
                    <option value="2">Show 'list' commands separately</option>
                </select>
                <button id="clear" class="button">Clear&nbsp;Log</button>
                <button id="export" class="button">Export&nbsp;Log</button>
            </div>
        </div>
    </div>
</body>

</html>